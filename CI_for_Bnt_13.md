<br><br><br><br>

# 13 - Panel Data and Fixed Effects

<br><br>

## Controlling What you Cannot See
- 성향점수(propensity score), 선형회귀, 매칭 등의 방법론은 무작위가 아닌 데이터에서의 교란(confounding)을 제어하는 좋은 수단이지만, 모두 **조건부 비교란성(conditional unconfoundedness)** 이라는 하나의 중요한 가정에 의존한다. ($(Y_0,Y_1 \perp T \bar X)$)
- 말로 풀어서 설명하자면, 모든 교란변수들을 우리가 알고 있고 측정가능해서 그들을 모두 조건화하여 처리 수준이 무작위로 배정된 것과 같이 되어야 한다는 것이다. 이에 대한 중요한 이슈 중 하나는, 가끔 우리가 교란변수를 알고도 측정하지 못한다는 데에 있다. 
  - 예시 : 교육수준, 결혼, 외모가 수입에 미치는 영향
    - 남자의 수입에 결혼이 미치는 영향을 밝혀내는 문제에 대해 생각해보자. 기혼 남성이 더 많은 돈을 번다는 것은 경제학에서 잘 알려진 사실이다. 그러나, 이러한 관계성이 인과성으로 이어지는지는 확실하지 않다. 교육을 더 많이 받은 사람이 결혼도 많이 하고 수입도 높을 가능성이 있는 것이다. (즉, 교육수준이 결혼이 수입에 미치는 영향에 대한 교란변수가 된다.) 이러한 교란변수에 대해, 우리는 교육수준을 츶겅하고 이를 조건화한 회귀식을 세울 수 있었다. 
    - 하지만 또다른 교란변수로 외모가 있을 수 있다. 얼굴이 잘생길수록 결혼할 가능성과 더 ㅁ많은 돈을 벌 가능성이 높을 것이다. 그러나, 외모는 지능처럼 우리가 쉽게 측정할 수 없는 무언가이다.

<br><br>

- 이는 우리를 어려운 상황에 처하게 한다. 우리가 측정되지 못한 교란변수를 가지고 있다면, 이는 곧 편향이 있음을 의미하기 때문이다. 이를 해결하는 방법은 이전에 보았던 것처럼 도구변수를 사용하는 방법이 있긴 하다. 그러나 좋은 도구변수를 떠올리는 것은 쉽지 않을 뿐더러 꽤 높은 수준의 창의력을 필요로 한다. 따라서, 다른 대안을 살펴보자. 
- 아이디어는 **패널 데이터**를 사용하자는 것이다. 패널 데이터는 같은 개인에 대하여 각 시기에 따른 다수의 데이터를 관찰한 것을 말한다. 패널 데이터 형식은 현업에서는 매우 흔한데, 그들이 고객의 행동 데이터를 시기마다 보관하기에 그렇다. 패널 데이터를 우리가 활용할 수 있는 이유는 개인별로 처리 전후를 관찰하여 그들이 어떻게 행동했는지를 확인할 수 있기 때문이다. 수학의 세계로 들어가기 이전에, 이게 어떤 직관을 주는지를 먼저 살펴보자.

<br><br>

- 먼저, 아래의 인과그래프를 보자. 같은 유닛에 대한 시계열 데이터이다. 첫 번째(1기) 결혼이 동시에 소득과 그 이후의 결혼 상태를 야기하는 상황을 가정해보자. 이러한 관계성은 2기와 3기에도 마찬가지다. 또한, 외모는 모든 시기 전반에 관여하며 결혼과 수입에 영향을 준다고 가정한다.
<img src="https://github.com/DoyoungKim12/causal-inference/blob/master/img_BnT/bnt_32.PNG?raw=true">

<br><br>

- 우리는 외모라는 변수를 측정할 수 없기 때문에 조건화할 수 없다. 그러나 우리는 패널 구조를 사용하기 때문에 이제 이는 더이상 문제가 되지 않는다. 아이디어는 외모와 같은 다른 모든 속성들이 시간의 흐름에도 일정하다고 보는 것이다. 따라서 우리가 그들을 직접 조건화할 수 없더라도, 우리는 이를 개인 자체의 데이터를 보는 것으로 통제할 수 있다. 
<img src="https://github.com/DoyoungKim12/causal-inference/blob/master/img_BnT/bnt_33.PNG?raw=true">

<br><br>

- 생각해보자. 우리는 외모나 지능과 같은 속성을 측정할 수 없지만 그러한 사람의 속성은 시간이 지나도 동일하다는 것을 안다. 따라서, 우리는 개인을 특정하는 더미 변수를 생성하여 이를 선형 모델에 추가할 수 있다. 이것이 바로 우리가 개인 그 자체로 조건화한다는 것의 의미이다. 개인 더미 변수를 모델에 추가한 상태에서 수입에 대한 결혼의 영향을 측정할 때, 회귀 모델은 개인 변수를 고정한 상태에서 결혼의 효과를 추정한다. 이처럼 개인 변수(entity dummy)를 추가한 것을 수정된 효과 모델(fixed effect model)이라고 부른다.

<br><br>

## Fixed Effects
- 문제를 보다 정형화하기 위해, 우리가 가진 데이터를 보자. 우리가 가진 예시를 따라, 결혼이 수입에 미치는 효과를 추정해볼 것이다. 데이터는 이 2개 변수(결혼과 임금)를 포함하는데, 다수의 개인에 대한 다년간의 데이터 또한 포함한다. (여기서 임금은 로그변환된 값이다.) 추가로, 우리는 조건화할 대상들 또한 가지고있다. (일한 시간, 학력 등...)

```python
from linearmodels.datasets import wage_panel
data = wage_panel.load()
data.head()
```
<img src="https://github.com/DoyoungKim12/causal-inference/blob/master/img_BnT/bnt_34.PNG?raw=true">

<br><br>

- 일반적으로, 수정된 효과 모델은 아래와 같이 정의된다.
 $$y_{it} = \betaX_{it} + \gammaU_i + e_{it}$$
 
- $y_{it}$는 개인 i의 t기 결과이다.
- $X_{it}$는 t기의 개인 i에 대한 변수 벡터이다. (관찰가능한 결혼 또는 경험 등)
- $U_{i}$는 개인 i에 대해 관찰되지 않은 것들(unobservables)이다. (외모, 지능 등)
  - 관찰되지 않는 것들은 시간에 따라 변하지 않기 때문에 t가 생략된다.
- $e_{it}$는 오차항이다.

<br><br>

- 이제, 수정된 효과 모델에 패널 데이터를 사용하는 것은 개인에 대한 더미 변수를 더하는 것처럼 단순한 것이라고 했던 나의 말을 다시 떠올려보자. 맞는 말이긴 하지만, 실제로는 우린 그렇게 하진 않을 것이다. 100만명의 고객이 있는 데이터셋을 상상해보라. 각각에 대한 더미를 더한다면, 1백만개의 열이 생겨나게 될 것이고 이는 아마 좋은 생각이 아닐 것이다. 대신, 우리는 선형회귀를 2개의 분리된 모델로 나누는 트릭을 적용할 것이다. 이 트릭은 이전에 보았던 것이지만 한번 더 요약하기 좋은 타이밍이 되었다.
- 어떤 feature들의 집합인 $X_1$과 다른 feature들의 집합인 $X_2$로 이루어진 선형회귀 모델이 하나 있다고 가정하자.

$$\hat{Y} = \hat{\beta_1}X_1 + \hat{\beta_2}X_2$$

- $X_1$과 $X_2$는 feature의 행렬로, 행은 feature, 열은 관측된 값들(observation)이다.
- $\beta_1$과 $\beta_2$는 행백터이다. 아래와 같은 방법으로 정확히 같은 $\beta_1$을 얻을 수 있다.

1. 결과 y에 대한 회귀식을 두번째 집합의 feature들로만 구성한다. ($\hat{y^\*} = \hat{\gamma_1}X_2$)
2. 첫번째 집합의 feature에 대한 회귀식을 두번째 집합으로 구성한다. ($\hat{X_1} = \hat{\gamma_2}X_2$)
3. 1과 2의 잔차를 구한다. ($\tilde{X_1} = X_1 - \hat{X_1}$, $\tilde{y_1} = y_1 - \hat{y^\*}$)
4. y 잔차에 대한 회귀식을 첫번째 집합 feature의 잔차로 구성한다. ($\tilde{y} = \hat{\beta_1}\tilde{X_1}$)

<br><br>

- 마지막 회귀에서의 계수는 모든 feature를 사용한 회귀식에서와 같을 것이다. 그런데 이게 어떻게 우리에게 도움이 된다는 것일까? 우리는 개인 더미변수를 사용한 모델의 추정치를 2개로 나눌 수 있다. 먼저, 우리는 더미변수들을 각각 결과와 다른 feature들을 예측하는 데에 사용했다. 이것이 각각 위의 1단계와 2단계이다.
- 이제, 더미 변수로 회귀식을 구성하는 것이 그 더미에 대한 평균을 추정하는 것만큼 단순하다는 것을 확인해보자. 우리의 데이터가 그게 진짜라는 사실을 보여줄 것이다. 연도를 더미변수로 하여, 그 변수에 대한 함수로 임금을 예측하는 모델을 만들어보자.

```python
mod = smf.ols("lwage ~ C(year)", data=data).fit()
mod.summary().tables[1]
```
<img src="https://github.com/DoyoungKim12/causal-inference/blob/master/img_BnT/bnt_35.PNG?raw=true">















